<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Buques</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            display: flex;
            gap: 20px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 1200px;
        }
        .left-panel, .right-panel {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .left-panel { flex: 0.5; min-width: 300px; }
        .right-panel { flex: 1.5; }

        .left-panel h2 {
            margin-top: 0;
            color: #333;
        }
        /* Contenedor del título de la tabla y el botón Regresar */
        .right-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .right-panel-header h2 {
            margin: 0;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: calc(100% - 22px); /* Ajusta por padding y borde */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        .buttons-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .buttons-container button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            color: white;
            flex-grow: 1;
            min-width: 120px;
        }
        #registerBuqueBtn { background-color: #28a745; } /* Verde */
        #saveChangesBtn { background-color: #007bff; display: none; } /* Azul */
        #deleteBuqueBtn { background-color: #dc3545; display: none; } /* Rojo */

        /* Estilos específicos para el botón "Regresar" */
        #returnToMainBtn {
            background-color: #6c757d; /* Gris */
            padding: 8px 12px; /* Más compacto, como el botón de búsqueda */
            flex-grow: 0; /* No se expande */
            min-width: unset; /* Quita el ancho mínimo global */
            align-self: flex-start; /* Alinea al inicio si hay más espacio */
        }

        .right-panel .search-bar {
            display: flex;
            margin-bottom: 15px;
            gap: 10px;
        }
        .right-panel .search-bar input[type="text"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .right-panel .search-bar button {
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table thead th {
            background-color: #f2f2f2;
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        table tbody td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        table tbody tr:hover {
            background-color: #f9f9f9;
            cursor: pointer;
        }
        .no-data {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        .selected-row {
            background-color: #e0f7fa !important;
            border: 1px solid #00bcd4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <h2>Detalles del Buque</h2>
            <div class="form-group">
                <label for="buqueNombre">Nombre:</label>
                <input type="text" id="buqueNombre">
            </div>
            <div class="form-group">
                <label for="buqueMatricula">Matrícula:</label>
                <input type="text" id="buqueMatricula">
            </div>
            <div class="form-group">
                <label for="buqueCapacidad">Capacidad (Toneladas):</label>
                <input type="number" id="buqueCapacidad" step="0.01">
            </div>
            <div class="form-group">
                <label for="buqueTipo">Tipo de Buque:</label>
                <select id="buqueTipo">
                    <option value="">Cargando tipos...</option>
                </select>
            </div>
            <div class="buttons-container">
                <button id="registerBuqueBtn">Registrar buque</button>
                <button id="saveChangesBtn">Guardar cambios</button>
                <button id="deleteBuqueBtn">Eliminar buque</button>
            </div>
        </div>

        <div class="right-panel">
            <div class="right-panel-header">
                <h2>Listado de Buques</h2>
                <button id="returnToMainBtn">Regresar</button> <!-- Botón Regresar -->
            </div>
            <div class="search-bar">
                <input type="text" id="searchMatricula" placeholder="Buscar por Matrícula">
                <button id="searchBtn">Buscar</button>
            </div>
            <div id="buqueTableContainer">
                <table id="buqueTable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Matrícula</th>
                            <th>Capacidad (Ton)</th>
                            <th>Tipo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos de los buques se insertarán aquí con JavaScript -->
                    </tbody>
                </table>
                <p id="noBuquesMessage" class="no-data">No hay buques registrados.</p>
            </div>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. Obtención de Elementos del DOM
        // ----------------------------------------------------
        const buqueNombreInput = document.getElementById('buqueNombre');
        const buqueMatriculaInput = document.getElementById('buqueMatricula');
        const buqueCapacidadInput = document.getElementById('buqueCapacidad');
        const buqueTipoSelect = document.getElementById('buqueTipo');

        const registerBuqueBtn = document.getElementById('registerBuqueBtn');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        const deleteBuqueBtn = document.getElementById('deleteBuqueBtn');
        const returnToMainBtn = document.getElementById('returnToMainBtn'); // Referencia al nuevo botón

        const buqueTableBody = document.querySelector('#buqueTableContainer tbody');
        const noBuquesMessage = document.getElementById('noBuquesMessage');
        const buqueTable = document.querySelector('#buqueTableContainer table');

        const searchMatriculaInput = document.getElementById('searchMatricula');
        const searchBtn = document.getElementById('searchBtn');

        // Estado local para el buque seleccionado (almacenaremos la matrícula para PUT/DELETE)
        let selectedBuqueMatricula = null;
        let selectedRowElement = null; // Para resaltar la fila seleccionada

        // Base URL de tu API para esta aplicación (ajusta si tu proyecto está en otro prefijo)
        const API_BASE_URL = '/buques/api';


        // ----------------------------------------------------
        // 2. Funciones de Utilidad y UI
        // ----------------------------------------------------

        function clearForm() {
            buqueNombreInput.value = '';
            buqueMatriculaInput.value = '';
            buqueCapacidadInput.value = '';
            buqueTipoSelect.value = ''; // Limpiar select
            selectedBuqueMatricula = null; // Deseleccionar buque
            if (selectedRowElement) {
                selectedRowElement.classList.remove('selected-row');
                selectedRowElement = null;
            }
            resetButtons(); // Restablecer botones a "registrar"
        }

        function resetButtons() {
            registerBuqueBtn.style.display = 'inline-block';
            saveChangesBtn.style.display = 'none';
            deleteBuqueBtn.style.display = 'none';
            buqueMatriculaInput.readOnly = false; // Matrícula editable para nuevo registro
        }

        function setEditButtons() {
            registerBuqueBtn.style.display = 'none';
            saveChangesBtn.style.display = 'inline-block';
            deleteBuqueBtn.style.display = 'inline-block';
            buqueMatriculaInput.readOnly = true; // Matrícula no editable en modo edición
        }

        function showMessage(message, isError = false) {
            alert(message); // Simple alert
            if (isError) {
                console.error("ERROR: ", message);
            } else {
                console.log("INFO: ", message);
            }
        }

        // ----------------------------------------------------
        // 3. Funciones de Interacción con la API (AJAX con fetch)
        // ----------------------------------------------------

        // Obtener y renderizar todos los buques
        async function fetchAndRenderBuques() {
            try {
                const response = await fetch(`${API_BASE_URL}/buques/`);
                if (!response.ok) {
                    throw new Error(`Error HTTP! Estado: ${response.status}`);
                }
                const buques = await response.json();
                renderTable(buques);
            } catch (error) {
                showMessage(`Error al cargar buques: ${error.message}. Asegúrate de que el servidor Django esté corriendo y las URLs sean correctas.`, true);
            }
        }

        // Obtener y poblar el select de tipos de buque
        async function populateTiposBuque() {
            try {
                const response = await fetch(`${API_BASE_URL}/tipos-buque/`);
                if (!response.ok) {
                    throw new Error(`Error HTTP! Estado: ${response.status}`);
                }
                const tipos = await response.json();

                buqueTipoSelect.innerHTML = '<option value="">Seleccione un tipo</option>';
                tipos.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.id; // Usamos el ID del tipo
                    option.textContent = tipo.nombre; // El nombre del tipo (ej. "Carga")
                    buqueTipoSelect.appendChild(option);
                });
            } catch (error) {
                showMessage(`Error al cargar tipos de buque: ${error.message}.`, true);
            }
        }

        // Renderiza la tabla de buques con los datos recibidos de la API
        function renderTable(buques) {
            buqueTableBody.innerHTML = ''; // Limpiar tabla
            if (buques.length === 0) {
                noBuquesMessage.style.display = 'block';
                buqueTable.style.display = 'none';
            } else {
                noBuquesMessage.style.display = 'none';
                buqueTable.style.display = 'table';
                buques.forEach(buque => {
                    const row = document.createElement('tr');
                    row.dataset.matricula = buque.matricula; // Almacenar la matrícula para selección
                    row.innerHTML = `
                        <td>${buque.nombre}</td>
                        <td>${buque.matricula}</td>
                        <td>${buque.capacidad}</td>
                        <td>${buque.tipo_nombre}</td>
                    `;
                    row.addEventListener('click', () => selectRow(row));
                    buqueTableBody.appendChild(row);
                });
            }
            clearForm(); // Siempre limpiar formulario después de renderizar tabla
        }

        // Selecciona una fila, obtiene los detalles del buque de la API y rellena el formulario
        async function selectRow(row) {
            if (selectedRowElement) {
                selectedRowElement.classList.remove('selected-row');
            }
            selectedRowElement = row;
            selectedRowElement.classList.add('selected-row');

            selectedBuqueMatricula = row.dataset.matricula; // Obtener la matrícula de la fila

            try {
                // Hacer una solicitud GET a la API para obtener los detalles del buque por su matrícula
                const response = await fetch(`${API_BASE_URL}/buques/${selectedBuqueMatricula}/`);
                if (!response.ok) {
                    throw new Error(`Error HTTP! Estado: ${response.status}`);
                }
                const buque = await response.json();

                // Rellenar los campos del formulario con los detalles del buque
                buqueNombreInput.value = buque.nombre;
                buqueMatriculaInput.value = buque.matricula; // Matrícula de la DB (no la del input)
                buqueCapacidadInput.value = buque.capacidad;
                buqueTipoSelect.value = buque.tipo_id; // Establecer el ID del tipo
                
                setEditButtons(); // Cambiar los botones a modo edición
            } catch (error) {
                showMessage(`Error al cargar detalles del buque: ${error.message}`, true);
                clearForm(); // Limpiar el formulario si falla la carga
            }
        }


        // ----------------------------------------------------
        // 4. Manejadores de Eventos (Botones y Búsqueda)
        // ----------------------------------------------------

        // Manejador para el botón "Registrar buque"
        registerBuqueBtn.addEventListener('click', async () => {
            const nombre = buqueNombreInput.value.trim();
            const matricula = buqueMatriculaInput.value.trim();
            const capacidad = buqueCapacidadInput.value;
            const id_tipo = buqueTipoSelect.value; // ID del tipo de buque

            // Validaciones básicas del lado del cliente
            if (!nombre || !matricula || capacidad === '' || !id_tipo) {
                showMessage('Por favor, complete todos los campos.', true);
                return;
            }

            // Datos a enviar al backend en formato JSON
            const dataToSend = {
                nombre: nombre,
                matricula: matricula,
                capacidad_toneladas: parseFloat(capacidad), // Convertir a float
                id_tipo: id_tipo, // Enviamos el ID del tipo de buque
            };

            try {
                const response = await fetch(`${API_BASE_URL}/buques/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage('Buque registrado exitosamente.');
                    fetchAndRenderBuques(); // Recargar la tabla
                } else {
                    let errorMessage = 'Error al registrar buque.';
                    // Mensaje de error si la matrícula ya existe
                    if (result.matricula && result.matricula.includes('already exists')) {
                        errorMessage = 'Ya existe un buque con esta matrícula.';
                    } else {
                        errorMessage += ' Detalles: ' + JSON.stringify(result);
                    }
                    showMessage(errorMessage, true);
                }
            } catch (error) {
                showMessage(`Error de conexión al registrar buque: ${error.message}.`, true);
            }
        });

        // Manejador para el botón "Guardar cambios"
        saveChangesBtn.addEventListener('click', async () => {
            if (!selectedBuqueMatricula) {
                showMessage('Ningún buque seleccionado para guardar cambios.', true);
                return;
            }

            // Usamos la matrícula del buque seleccionado para la URL PUT
            const matricula_for_url = selectedBuqueMatricula; 

            const nombre = buqueNombreInput.value.trim();
            const capacidad = buqueCapacidadInput.value;
            const id_tipo = buqueTipoSelect.value;

            // Validaciones básicas
            if (!nombre || capacidad === '' || !id_tipo) {
                showMessage('Por favor, complete todos los campos (excepto matrícula, que no se edita directamente).', true);
                return;
            }

            const dataToSend = {
                nombre: nombre,
                // No enviamos matrícula en el body para PUT ya que no se espera que cambie en la API
                capacidad_toneladas: parseFloat(capacidad),
                id_tipo: id_tipo,
            };

            try {
                const response = await fetch(`${API_BASE_URL}/buques/${matricula_for_url}/`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage('Cambios guardados exitosamente.');
                    fetchAndRenderBuques(); // Recargar la tabla
                } else {
                    showMessage('Error al guardar cambios. Detalles: ' + JSON.stringify(result), true);
                }
            } catch (error) {
                showMessage(`Error de conexión al guardar cambios: ${error.message}.`, true);
            }
        });

        // Manejador para el botón "Eliminar buque"
        deleteBuqueBtn.addEventListener('click', async () => {
            if (!selectedBuqueMatricula) {
                showMessage('Ningún buque seleccionado para eliminar.', true);
                return;
            }

            // Usamos la matrícula del buque seleccionado para la URL DELETE
            const matricula_for_url = selectedBuqueMatricula;

            if (!confirm(`¿Está seguro de que desea eliminar el buque con matrícula ${matricula_for_url}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/buques/${matricula_for_url}/`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    showMessage('Buque eliminado exitosamente.');
                    fetchAndRenderBuques(); // Recargar la tabla
                } else {
                    const result = await response.json();
                    showMessage('Error al eliminar buque. Detalles: ' + JSON.stringify(result), true);
                }
            } catch (error) {
                showMessage(`Error de conexión al eliminar buque: ${error.message}.`, true);
            }
        });

        // Manejador para el botón "Regresar"
        returnToMainBtn.addEventListener('click', () => {
            window.location.href = '/'; // Redirige a la página principal (raíz)
        });

        // Manejador para el botón "Buscar" (Filtra la tabla localmente por matrícula)
        searchBtn.addEventListener('click', () => {
            const searchTerm = searchMatriculaInput.value.trim().toLowerCase();
            const rows = buqueTableBody.querySelectorAll('tr');

            rows.forEach(row => {
                const matriculaCellContent = row.children[1].textContent.trim().toLowerCase(); // Matrícula está en la segunda celda
                if (matriculaCellContent.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });


        // ----------------------------------------------------
        // 5. Inicialización de la Aplicación
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // Cargar los tipos de buque primero
            populateTiposBuque();
            // Luego, cargar y renderizar los buques existentes
            fetchAndRenderBuques();
        });

    </script>
</body>
</html>