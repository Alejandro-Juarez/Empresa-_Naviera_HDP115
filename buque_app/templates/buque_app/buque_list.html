<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Buques</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            display: flex;
            gap: 20px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 1200px;
        }
        .left-panel, .right-panel {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .left-panel h2, .right-panel h2 {
            margin-top: 0;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        /* Estilos generales para campos de texto y select */
        .form-group input[type="text"],
        .form-group select {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        /* Nuevo estilo para input type="number" */
        .form-group input[type="number"] {
            -moz-appearance: textfield; /* Para Firefox */
            appearance: textfield; /* Estándar */
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        /* Oculta las flechas de incremento/decremento en navegadores WebKit (Chrome, Safari) */
        .form-group input[type="number"]::-webkit-outer-spin-button,
        .form-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .buttons-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .buttons-container button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            color: white;
        }
        #registerShipBtn {
            background-color: #28a745; /* Verde */
        }
        #saveChangesBtn {
            background-color: #007bff; /* Azul */
            display: none; /* Inicialmente oculto */
        }
        #deleteShipBtn {
            background-color: #dc3545; /* Rojo */
            display: none; /* Inicialmente oculto */
        }
        .right-panel .search-bar {
            display: flex;
            margin-bottom: 15px;
        }
        .right-panel .search-bar input[type="text"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }
        .right-panel .search-bar button {
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table thead th {
            background-color: #f2f2f2;
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        table tbody td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        table tbody tr:hover {
            background-color: #f9f9f9;
            cursor: pointer;
        }
        .no-data {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        /* Estilo para la fila seleccionada */
        .selected-row {
            background-color: #e0f7fa !important; /* Un color más claro para resaltar */
            border: 1px solid #00bcd4; /* Borde para el resaltado */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <h2>Detalles del Buque</h2>
            <div class="form-group">
                <label for="shipName">Nombre:</label>
                <input type="text" id="shipName">
            </div>
            <div class="form-group">
                <label for="shipMatricula">Matrícula:</label>
                <input type="text" id="shipMatricula">
            </div>
            <div class="form-group">
                <label for="shipType">Tipo de Buque:</label>
                <select id="shipType">
                    <!-- Las opciones se cargarán dinámicamente desde la API -->
                    <option value="">Cargando tipos...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="shipCapacity">Capacidad (Toneldas):</label>
                <input type="number" id="shipCapacity" step="any">
            </div>
            <div class="buttons-container">
                <button id="registerShipBtn">Registrar buque</button>
                <button id="saveChangesBtn">Guardar cambios</button>
                <button id="deleteShipBtn">Eliminar</button>
            </div>
        </div>

        <div class="right-panel">
            <h2>Listado de Buques</h2>
            <div class="search-bar">
                <input type="text" id="searchMatricula" placeholder="Buscar por Matrícula">
                <button id="searchBtn">Buscar</button>
            </div>
            <div id="shipTableContainer">
                <table id="shipTable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Matrícula</th>
                            <th>Tipo</th>
                            <th>Capacidad</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos de los buques se insertarán aquí con JavaScript -->
                    </tbody>
                </table>
                <p id="noShipsMessage" class="no-data">No hay buques registrados.</p>
            </div>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. Obtención de Elementos del DOM (Referencia a los elementos HTML)
        // ----------------------------------------------------
        const shipNameInput = document.getElementById('shipName');
        const shipMatriculaInput = document.getElementById('shipMatricula');
        const shipTypeSelect = document.getElementById('shipType'); // Este es el select para el tipo de buque
        const shipCapacityInput = document.getElementById('shipCapacity');

        const registerShipBtn = document.getElementById('registerShipBtn');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        const deleteShipBtn = document.getElementById('deleteShipBtn');

        const shipTableBody = document.querySelector('#shipTableContainer tbody');
        const noShipsMessage = document.getElementById('noShipsMessage');
        const shipTable = document.querySelector('#shipTableContainer table');

        const searchMatriculaInput = document.getElementById('searchMatricula');
        const searchBtn = document.getElementById('searchBtn');

        // Estado local para la fila seleccionada (ahora almacenaremos la matrícula y el elemento TR)
        let selectedBuqueMatricula = null;
        let selectedRowElement = null;

        // Base URL de tu API (ajusta si tu proyecto no está en '/buques/' en urls.py principal)
        // Por ejemplo, si tu path en tu urls.py principal es path('', include('buque_app.urls')),
        // entonces API_BASE_URL debería ser '/api'.
        const API_BASE_URL = '/buques/api';


        // ----------------------------------------------------
        // 2. Funciones de Utilidad y UI
        // ----------------------------------------------------

        // Función para limpiar el formulario y restablecer el estado de selección
        function clearForm() {
            shipNameInput.value = '';
            shipMatriculaInput.value = '';
            shipTypeSelect.value = ''; // Vaciar el select
            shipCapacityInput.value = '';
            selectedBuqueMatricula = null; // Reiniciar la matrícula del buque seleccionado
            // Quitar resaltado de la fila seleccionada si existe
            if (selectedRowElement) {
                selectedRowElement.classList.remove('selected-row');
                selectedRowElement = null;
            }
            resetButtons(); // Restablecer la visibilidad de los botones
        }

        // Función para restablecer los botones a su estado inicial (Registrar visible, otros ocultos)
        function resetButtons() {
            registerShipBtn.style.display = 'inline-block'; // Muestra el botón de registrar
            saveChangesBtn.style.display = 'none';    // Oculta el de guardar cambios
            deleteShipBtn.style.display = 'none';     // Oculta el de eliminar
            shipMatriculaInput.readOnly = false; // Permitir editar la matrícula para nuevos registros
        }

        // Función para cambiar los botones a modo edición (Registrar oculto, otros visibles)
        function setEditButtons() {
            registerShipBtn.style.display = 'none';         // Oculta el botón de registrar
            saveChangesBtn.style.display = 'inline-block';   // Muestra el de guardar cambios
            deleteShipBtn.style.display = 'inline-block';    // Muestra el de eliminar
            shipMatriculaInput.readOnly = true; // Bloquear edición de matrícula en modo edición
        }

        // Valida que la capacidad sea un número válido (entero o decimal)
        function isValidCapacity(value) {
            const num = parseFloat(value);
            return !isNaN(num) && isFinite(num) && value.trim() !== '';
        }

        // Muestra un mensaje de alerta (ejemplo simple, en producción usarías un modal o div de mensajes)
        function showMessage(message, isError = false) {
            alert(message);
            if (isError) {
                console.error("ERROR: ", message);
            } else {
                console.log("INFO: ", message);
            }
        }


        // ----------------------------------------------------
        // 3. Funciones de Interacción con la API (AJAX con fetch)
        // ----------------------------------------------------

        // Obtener todos los buques de la API y renderizar la tabla
        async function fetchAndRenderBuques() {
            try {
                const response = await fetch(`${API_BASE_URL}/buques/`);
                if (!response.ok) {
                    throw new Error(`Error HTTP! Estado: ${response.status}`);
                }
                const buques = await response.json();
                renderTable(buques);
            } catch (error) {
                showMessage(`Error al cargar buques: ${error.message}. Asegúrate de que el servidor Django esté corriendo y las URLs sean correctas.`, true);
            }
        }

        // Obtener los tipos de buque de la API y poblar el campo select
        async function populateShipTypes() {
            try {
                const response = await fetch(`${API_BASE_URL}/tipos-buque/`);
                if (!response.ok) {
                    throw new Error(`Error HTTP! Estado: ${response.status}`);
                }
                const tiposBuque = await response.json();

                shipTypeSelect.innerHTML = '<option value="">Seleccione un tipo</option>'; // Opción por defecto
                tiposBuque.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.id; // El valor será el ID del tipo de buque (lo que espera el backend)
                    option.textContent = tipo.nombre; // El texto visible será el nombre del tipo
                    shipTypeSelect.appendChild(option);
                });
            } catch (error) {
                showMessage(`Error al cargar tipos de buque: ${error.message}. Verifica la URL de la API de tipos.`, true);
            }
        }

        // Renderiza la tabla de buques con los datos recibidos de la API
        function renderTable(buques) {
            shipTableBody.innerHTML = ''; // Limpiar tabla
            if (buques.length === 0) {
                noShipsMessage.style.display = 'block';
                shipTable.style.display = 'none';
            } else {
                noShipsMessage.style.display = 'none';
                shipTable.style.display = 'table';
                buques.forEach(buque => {
                    const row = document.createElement('tr');
                    // Almacenar la matrícula en el dataset para fácil recuperación
                    row.dataset.matricula = buque.matricula;
                    row.innerHTML = `
                        <td>${buque.nombre}</td>
                        <td>${buque.matricula}</td>
                        <td>${buque.tipo_buque_nombre}</td> <!-- Mostrar el nombre del tipo de buque -->
                        <td>${buque.capacidad_toneladas}</td>
                    `;
                    // Añadir el evento click para seleccionar la fila
                    row.addEventListener('click', () => selectRow(row));
                    shipTableBody.appendChild(row);
                });
            }
            clearForm(); // Siempre limpiar formulario después de renderizar tabla
        }

        // Selecciona una fila, obtiene los detalles del buque de la API y rellena el formulario
        async function selectRow(row) {
            // Quitar resaltado de la fila previamente seleccionada
            if (selectedRowElement) {
                selectedRowElement.classList.remove('selected-row');
            }
            // Asignar la nueva fila seleccionada y añadir resaltado
            selectedRowElement = row;
            selectedRowElement.classList.add('selected-row');

            // Obtener la matrícula del buque seleccionado de la fila
            selectedBuqueMatricula = row.dataset.matricula;

            try {
                // Hacer una solicitud GET a la API para obtener los detalles del buque
                const response = await fetch(`${API_BASE_URL}/buques/${selectedBuqueMatricula}/`);
                if (!response.ok) {
                    throw new Error(`Error HTTP! Estado: ${response.status}`);
                }
                const buque = await response.json();

                // Rellenar los campos del formulario con los detalles del buque
                shipNameInput.value = buque.nombre;
                shipMatriculaInput.value = buque.matricula;
                shipTypeSelect.value = buque.tipo_buque_id; // Rellenar con el ID del tipo (para el select)
                shipCapacityInput.value = buque.capacidad_toneladas;

                setEditButtons(); // Cambiar los botones a modo edición (Guardar cambios, Eliminar)
            } catch (error) {
                showMessage(`Error al cargar detalles del buque: ${error.message}`, true);
                clearForm(); // Limpiar el formulario si falla la carga
            }
        }


        // ----------------------------------------------------
        // 4. Manejadores de Eventos (Botones y Búsqueda)
        // ----------------------------------------------------

        // Manejador para el botón "Registrar buque"
        registerShipBtn.addEventListener('click', async () => {
            const nombre = shipNameInput.value.trim();
            const matricula = shipMatriculaInput.value.trim();
            const tipo_buque_id = shipTypeSelect.value; // Obtenemos el ID del tipo de buque seleccionado
            const capacidad_toneladas = shipCapacityInput.value.trim();

            // Validaciones básicas del lado del cliente
            if (!nombre || !matricula || !tipo_buque_id || !capacidad_toneladas) {
                showMessage('Por favor, complete todos los campos.', true);
                return;
            }
            if (!isValidCapacity(capacidad_toneladas)) {
                showMessage('Por favor, ingrese una capacidad válida (número entero o decimal).', true);
                return;
            }

            // Datos a enviar al backend en formato JSON
            const dataToSend = {
                nombre: nombre,
                matricula: matricula,
                tipo_buque: tipo_buque_id, // Enviamos el ID del tipo de buque
                capacidad_toneladas: parseFloat(capacidad_toneladas)
            };

            try {
                // Realizar una solicitud POST a la API para crear un buque
                const response = await fetch(`${API_BASE_URL}/buques/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Para producción: 'X-CSRFToken': getCookie('csrftoken'), // Descomentar y usar función para obtener CSRF token
                    },
                    body: JSON.stringify(dataToSend) // Convertir el objeto a una cadena JSON
                });

                const result = await response.json(); // Leer la respuesta JSON del servidor
                if (response.ok) { // Si la respuesta HTTP es 2xx (éxito)
                    showMessage('Buque registrado exitosamente.');
                    fetchAndRenderBuques(); // Volver a cargar y renderizar la tabla desde la API
                } else { // Si la respuesta HTTP indica un error
                    let errorMessage = 'Error al registrar buque.';
                    // Mensajes de error más amigables basados en la respuesta del backend
                    if (result.matricula && result.matricula.includes('buque with this matricula already exists.')) {
                        errorMessage = 'Ya existe un buque con esta matrícula. Por favor, use una única.';
                    } else if (result.capacidad_toneladas && result.capacidad_toneladas.includes('Enter a number.')) {
                        errorMessage = 'La capacidad debe ser un número.';
                    } else {
                        errorMessage += ' Detalles: ' + JSON.stringify(result);
                    }
                    showMessage(errorMessage, true);
                }
            } catch (error) {
                showMessage(`Error de conexión al registrar buque: ${error.message}. Verifique el servidor.`, true);
            }
        });


        // Manejador para el botón "Guardar cambios"
        saveChangesBtn.addEventListener('click', async () => {
            if (!selectedBuqueMatricula) {
                showMessage('Ningún buque seleccionado para guardar cambios.', true);
                return;
            }

            const nombre = shipNameInput.value.trim();
            const matricula = shipMatriculaInput.value.trim(); // La matrícula se usa para identificar, no se edita en este modo
            const tipo_buque_id = shipTypeSelect.value;
            const capacidad_toneladas = shipCapacityInput.value.trim();

            // Validaciones básicas del lado del cliente
            if (!nombre || !matricula || !tipo_buque_id || !capacidad_toneladas) {
                showMessage('Por favor, complete todos los campos.', true);
                return;
            }
            if (!isValidCapacity(capacidad_toneladas)) {
                showMessage('Por favor, ingrese una capacidad válida (número entero o decimal).', true);
                return;
            }

            // Datos a enviar al backend
            const dataToSend = {
                nombre: nombre,
                matricula: matricula, // La matrícula no se envía como parte del PUT en el path, pero si el backend la espera en el body
                tipo_buque: tipo_buque_id,
                capacidad_toneladas: parseFloat(capacidad_toneladas)
            };

            try {
                // Realizar una solicitud PUT a la API para actualizar un buque específico
                const response = await fetch(`${API_BASE_URL}/buques/${selectedBuqueMatricula}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        // Para producción: 'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify(dataToSend)
                });

                const result = await response.json();
                if (response.ok) { // Si la respuesta HTTP es 2xx (éxito)
                    showMessage('Cambios guardados exitosamente.');
                    fetchAndRenderBuques(); // Recargar la tabla para mostrar los cambios
                } else { // Si la respuesta HTTP indica un error
                    showMessage('Error al guardar cambios. Detalles: ' + JSON.stringify(result), true);
                }
            } catch (error) {
                showMessage(`Error de conexión al guardar cambios: ${error.message}. Verifique el servidor.`, true);
            }
        });


        // Manejador para el botón "Eliminar"
        deleteShipBtn.addEventListener('click', async () => {
            if (!selectedBuqueMatricula) {
                showMessage('Ningún buque seleccionado para eliminar.', true);
                return;
            }

            // Pedir confirmación al usuario
            if (!confirm(`¿Está seguro de que desea eliminar el buque con matrícula ${selectedBuqueMatricula}?`)) {
                return; // Si el usuario cancela, no hacer nada
            }

            try {
                // Realizar una solicitud DELETE a la API para eliminar un buque específico
                const response = await fetch(`${API_BASE_URL}/buques/${selectedBuqueMatricula}/`, {
                    method: 'DELETE',
                    headers: {
                        // Para producción: 'X-CSRFToken': getCookie('csrftoken'),
                    },
                });

                if (response.ok) { // Si la respuesta HTTP es 204 (No Content) o 2xx
                    showMessage('Buque eliminado exitosamente.');
                    fetchAndRenderBuques(); // Recargar la tabla para reflejar la eliminación
                } else { // Si la respuesta HTTP indica un error
                    const result = await response.json(); // Intentar leer el error si hay un cuerpo JSON
                    showMessage('Error al eliminar buque. Detalles: ' + JSON.stringify(result), true);
                }
            } catch (error) {
                showMessage(`Error de conexión al eliminar buque: ${error.message}. Verifique el servidor.`, true);
            }
        });


        // Manejador para el botón "Buscar" (Filtra la tabla localmente)
        searchBtn.addEventListener('click', () => {
            const searchTerm = searchMatriculaInput.value.trim().toLowerCase();
            const rows = shipTableBody.querySelectorAll('tr'); // Obtener todas las filas actuales en la tabla

            rows.forEach(row => {
                const matriculaCellContent = row.children[1].textContent.toLowerCase(); // La matrícula está en la segunda celda
                if (matriculaCellContent.includes(searchTerm)) {
                    row.style.display = ''; // Mostrar la fila si coincide
                } else {
                    row.style.display = 'none'; // Ocultar la fila si no coincide
                }
            });
            // Considera añadir un botón "Limpiar búsqueda" para volver a mostrar todas las filas
        });

        // Opcional: Función para obtener el token CSRF de las cookies (necesario para producción)
        // function getCookie(name) {
        //     let cookieValue = null;
        //     if (document.cookie && document.cookie !== '') {
        //         const cookies = document.cookie.split(';');
        //         for (let i = 0; i < cookies.length; i++) {
        //             const cookie = cookies[i].trim();
        //             if (cookie.substring(0, name.length + 1) === (name + '=')) {
        //                 cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        //                 break;
        //             }
        //         }
        //     }
        //     return cookieValue;
        // }


        // ----------------------------------------------------
        // 5. Inicialización de la Aplicación (Cuando la página carga)
        // ----------------------------------------------------

        // Se ejecuta cuando el contenido HTML de la página está completamente cargado
        document.addEventListener('DOMContentLoaded', () => {
            populateShipTypes(); // Primero, carga los tipos de buque para rellenar el select
            fetchAndRenderBuques(); // Luego, carga y renderiza los buques existentes en la tabla
        });

    </script>
</body>
</html>